<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>RECEBIMENTO - M√ìVEIS SIMONETTI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />

    <style>
        :root { --blue-ms: #1E90FF; --dark-blue: #104E8B; --bg: #F0F8FF; --border-dark: #333333; }
        body { background: var(--bg); font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 10px; }
        
        #userBar { background: var(--dark-blue); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; color: white; margin-bottom: 10px; }
        .back-arrow { cursor: pointer; font-size: 24px; text-decoration: none; color: white; font-weight: bold; }
        
        h1 { background: var(--dark-blue); color: white; text-align: center; padding: 15px; border-radius: 4px; margin: 0 0 20px 0; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; }

        .dashboard { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; }
        .chart-box { max-width: 550px; height: 350px; margin: 0 auto; }
        
        #totalVisual { 
            font-size: 18px; font-weight: bold; color: var(--dark-blue); 
            margin: 20px auto 0; border: 2px solid var(--blue-ms); 
            padding: 12px 30px; border-radius: 50px; background: #fff; 
            display: inline-block; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .toolbar { display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px; align-items: center; position: relative; }
        #mainSearch { padding: 10px 15px; border: 1px solid #ccc; border-radius: 6px; width: 250px; outline: none; }
        .btn-share { background: var(--blue-ms); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        .table-container { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table.dataTable { width: 100% !important; border-collapse: collapse !important; border: 1px solid var(--border-dark) !important; }
        
        table.dataTable thead th { background: var(--dark-blue) !important; color: white !important; font-size: 11px; text-transform: uppercase; padding: 12px; border: 1px solid var(--border-dark) !important; text-align: center !important; }
        table.dataTable tbody td { border: 1px solid var(--border-dark) !important; text-align: center !important; padding: 10px !important; font-size: 13px; }
        
        /* Efeito Zebra (Linhas saltadas) */
        table.dataTable tbody tr:nth-child(even) { background-color: #f9f9f9; }
        table.dataTable tbody tr:hover { background-color: #f1f7ff; }

        .col-hidden { display: none; }
        .pill { padding: 6px 12px; border-radius: 15px; font-size: 11px; font-weight: bold; display: inline-block; min-width: 110px; color: #fff; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }

        .filter-btn { width: 95%; margin-top: 5px; padding: 4px; font-size: 10px; background: rgba(255,255,255,0.2); color: white; border: 1px solid #fff; cursor: pointer; border-radius: 3px; font-weight: bold; }
        .filter-applied { background: #FFD700 !important; color: #000 !important; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 350px; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
    </style>
</head>
<body>

<div id="userBar">
    <div><a href="index.html" class="back-arrow">‚Üê</a> <span id="userName" style="margin-left:15px; font-weight:bold; font-size: 16px;">Operador</span></div>
    <button onclick="localStorage.clear(); window.location.href='login.html'" style="background:transparent; color:white; border:1px solid #fff; padding:5px 15px; border-radius:4px; cursor:pointer; font-weight: bold;">SAIR</button>
</div>

<h1>RECEBIMENTO DO DIA</h1>

<div class="dashboard">
    <div class="chart-box"><canvas id="statusChart"></canvas></div>
    <div id="totalVisual">Processando dados...</div>
</div>

<div class="toolbar">
    <input type="text" id="mainSearch" placeholder="üîç Buscar carga ou fornecedor...">
    <button class="btn-share" onclick="$('#dropContent').toggle()">COMPARTILHAR ‚ñº</button>
    <div id="dropContent" style="display:none; position:absolute; right:0; top:45px; background:white; border:1px solid #ccc; box-shadow:0 4px 12px rgba(0,0,0,0.15); z-index:100; border-radius:6px; min-width: 180px;">
        <button onclick="exportarPDF()" style="display:block; width:100%; padding:12px; border:none; background:none; cursor:pointer; text-align:left; border-bottom:1px solid #eee; font-weight: 500;">üìÑ PDF Profissional</button>
        <button onclick="exportarExcel()" style="display:block; width:100%; padding:12px; border:none; background:none; cursor:pointer; text-align:left; font-weight: 500;">üìä Planilha Excel</button>
    </div>
</div>

<div class="table-container">
    <table id="tabelaReceb" class="display nowrap cell-border" style="width:100%">
        <thead><tr id="headerRow"></tr></thead>
        <tbody></tbody>
    </table>
</div>

<div id="modalFiltro" class="modal-overlay">
    <div class="modal-content">
        <div style="background: var(--dark-blue); color: white; padding: 15px; font-weight: bold; text-align: center;" id="modalTitle">FILTRAR</div>
        <div id="listCheckboxes" style="max-height:300px; overflow-y:auto; padding:10px;"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 15px; background: #f1f1f1;">
            <button onclick="limparFiltro()" style="padding: 8px; cursor: pointer; border: 1px solid #ccc;">LIMPAR</button>
            <button onclick="$('#modalFiltro').hide()" style="padding: 8px; cursor: pointer; border: 1px solid #ccc;">FECHAR</button>
            <button onclick="toggleChecks(true)" style="padding: 8px; cursor: pointer; border: 1px solid #ccc;">TODOS</button>
            <button onclick="toggleChecks(false)" style="padding: 8px; cursor: pointer; border: 1px solid #ccc;">NENHUM</button>
            <button onclick="aplicarFiltro()" style="grid-column: span 2; background: var(--dark-blue); color:white; border:none; padding:10px; border-radius:5px; font-weight:bold; cursor: pointer;">APLICAR FILTRO</button>
        </div>
    </div>
</div>

<script>
Chart.register(ChartDataLabels);

const csvUrl = "https://docs.google.com/spreadsheets/d/1Ore02M4GARvE6hldNDZmiVNDrABb4dgaZO7wlMY-fjs/export?format=csv&gid=2090543957";
// Altera√ß√£o solicitada: de QTD para CODIGO
const colunas = ["CODIGO", "ORDEM DE AGENDA", "DATA", "CENTRAL", "CARGAS", "STATUS", "FORNECEDOR", "TIPO DE PRODUTO", "BOX"];
const coresStatus = {
    "CARGA RECEBIDA": '#4CAF50', "NO PATIO - FICOU P/ AMANH√É": '#3ACFB9', "CANCELADA": '#7a002b',    
    "SOB AJUSTE": '#8B27F5', "NO PATIO - SOB ENCAIXE": '#ff7625', "NO PATIO - FICOU DE ONTEM": '#B249BF',
    "EM RECEBIMENTO": '#FFC107', "NO PATIO": '#03A9F4', "EM ATRASO": '#F44336', "REAGENDA": '#9B591B'
};

function getColorTipoProduto(text) {
    const tp = (text || "").toUpperCase();
    if (['ROUPEIRO', 'ARMARIO', 'COZINHA', 'PAINEL', 'MODULO', 'MULTIUSO', 'BALCAO', 'COMODA'].some(x => tp.includes(x))) return '#FFFF00';
    if (['CELULAR', 'TABLET', 'RELOGIO', 'ROBO', 'NOTEBOOK'].some(x => tp.includes(x))) return '#00BFFF';
    if (tp.includes('MESA')) return '#4CAF50';
    return null;
}

let table, chartStatus, curIdx;

$(document).ready(function() {
    $("#userName").text("Bem-vindo, " + (localStorage.getItem("username") || "Operador"));
    Papa.parse(csvUrl, { download: true, header: true, skipEmptyLines: true, complete: res => inicializar(res.data) });
    $(document).click(e => { if(!$(e.target).closest('.toolbar').length) $('#dropContent').hide(); });
});

function inicializar(dados) {
    const h = $("#headerRow").empty();
    colunas.forEach((c, i) => {
        h.append(`<th class="${i===0?'col-hidden':''}">
            ${c} <br> <button class="filter-btn" id="fbtn-${i}" onclick="event.stopPropagation(); openModal(${i},'${c}')">FILTRAR</button>
        </th>`);
    });

    const body = $("#tabelaReceb tbody").empty();
    dados.forEach(r => {
        const st = (r["STATUS"] || "").trim().toUpperCase();
        const tp = (r["TIPO DE PRODUTO"] || "").trim().toUpperCase();
        const tpColor = getColorTipoProduto(tp);
        
        body.append(`<tr>
            <td class="col-hidden">${r["CODIGO"] || r["ID"] || ""}</td>
            <td>${r["ORDEM DE AGENDA"] || ""}</td>
            <td>${(r["DATA"] || "").replace(/\*/g, "")}</td>
            <td>${(r["CENTRAL"] || "").replace(/\*/g, "")}</td>
            <td>${r["CARGAS"] || ""}</td>
            <td><span class="pill" style="background:${coresStatus[st] || '#4682B4'}">${st}</span></td>
            <td>${r["FORNECEDOR"] || ""}</td>
            <td style="${tpColor ? 'background:'+tpColor+'; font-weight:bold;' : ''}">${tp}</td>
            <td>${r["BOX"] || ""}</td>
        </tr>`);
    });

    table = $('#tabelaReceb').DataTable({ 
        paging: false, info: false, dom: 'rt', scrollX: true, ordering: true,
        order: [[0, 'asc']],
        columnDefs: [{ targets: 0, visible: false }]
    });
    
    $('#mainSearch').on('keyup', function() { table.search(this.value).draw(); updateDashboard(); });
    updateDashboard();
}

function updateDashboard() {
    const visibleRows = table.rows({ search: 'applied' }).nodes().to$();
    const idsCarros = new Set();
    const stats = {};

    visibleRows.each(function() {
        const rowData = table.row(this).data();
        const qtdVal = rowData[0]; 
        const st = $(this).find('td:eq(4)').text().trim();
        
        if(qtdVal) idsCarros.add(qtdVal);
        if(st) stats[st] = (stats[st] || 0) + 1;
    });

    $("#totalVisual").html(`CARROS: ${idsCarros.size} | AGENDAS: ${visibleRows.length}`);

    if(chartStatus) chartStatus.destroy();
    
    const totalAgendas = visibleRows.length;
    const labelsWithCounts = Object.keys(stats).map(k => `${k} (${stats[k]})`);

    chartStatus = new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: { 
            labels: labelsWithCounts, 
            datasets: [{ 
                data: Object.values(stats), 
                backgroundColor: Object.keys(stats).map(k => coresStatus[k] || "#ccc") 
            }] 
        },
        options: { 
            maintainAspectRatio: false, 
            plugins: { 
                title: { display: true, text: 'STATUS DAS AGENDAS (%)', font: { size: 16, weight: 'bold' } },
                legend: { position: 'right' },
                datalabels: {
                    color: '#fff',
                    font: { weight: 'bold', size: 12 },
                    formatter: (value) => {
                        return ((value / totalAgendas) * 100).toFixed(1) + "%";
                    }
                }
            } 
        }
    });
}

function openModal(idx, title) {
    curIdx = idx;
    $("#modalTitle").text(title);
    const uniqueVals = table.column(idx, {search:'applied'}).data().unique().sort().toArray().map(v => v.replace(/<[^>]*>/g, "").trim());
    const list = $("#listCheckboxes").empty();
    uniqueVals.forEach(v => {
        list.append(`<label style="display:block; padding:10px; border-bottom:1px solid #eee; cursor:pointer;">
            <input type="checkbox" value="${v}" checked> ${v}
        </label>`);
    });
    $("#modalFiltro").css("display", "flex");
}

function toggleChecks(bool) {
    $("#listCheckboxes input").prop("checked", bool);
}

function aplicarFiltro() {
    const sel = $("#listCheckboxes input:checked").map(function(){ return this.value; }).get();
    const regex = sel.length > 0 ? sel.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|') : "NONE_SELECTED";
    table.column(curIdx).search(regex, true, false).draw();
    $(`#fbtn-${curIdx}`).toggleClass("filter-applied", sel.length < $("#listCheckboxes input").length);
    $("#modalFiltro").hide();
    updateDashboard();
}

function limparFiltro() {
    table.column(curIdx).search('').draw();
    $(`#fbtn-${curIdx}`).removeClass("filter-applied");
    $("#modalFiltro").hide();
    updateDashboard();
}

function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    table.order([0, 'asc']).draw();
    const rows = table.rows({ search: 'applied' }).nodes().to$();
    
    // CABE√áALHO AZUL ELEGANTE
    doc.setFillColor(16, 78, 139); doc.rect(0, 0, 297, 25, 'F');
    
    // TEXTO "MS" EM DESTAQUE
    doc.setTextColor(255, 255, 255); 
    doc.setFont("helvetica", "bold"); 
    doc.setFontSize(24); 
    doc.text("MS", 15, 16); 
    
    // T√çTULO
    doc.setFontSize(16); 
    doc.text("RECEBIMENTO - M√ìVEIS SIMONETTI", 45, 15);
    
    const idsPDF = new Set();
    rows.each(function() { idsPDF.add(table.row(this).data()[0]); });
    doc.setFontSize(10);
    doc.text(`CARROS: ${idsPDF.size} | AGENDAS: ${rows.length}`, 240, 15);
    
    const body = [];
    rows.each(function() { 
        let r = [];
        const rowData = table.row(this).data();
        rowData.forEach(val => r.push(val.replace(/<[^>]*>/g, "").trim()));
        body.push(r); 
    });

    doc.autoTable({
        startY: 30, head: [colunas], body: body,
        styles: { fontSize: 7, halign: 'center', valign: 'middle', lineColor: [51, 51, 51], lineWidth: 0.1 },
        headStyles: { fillColor: [16, 78, 139] },
        didParseCell: function(data) {
            if (data.section === 'body' && data.column.index === 5) {
                const val = data.cell.raw.toUpperCase();
                if (coresStatus[val]) {
                    data.cell.styles.fillColor = coresStatus[val];
                    data.cell.styles.textColor = [255, 255, 255];
                    data.cell.styles.fontStyle = 'bold';
                }
            }
            if (data.section === 'body' && data.column.index === 7) {
                const color = getColorTipoProduto(data.cell.raw);
                if (color) {
                    data.cell.styles.fillColor = color;
                    data.cell.styles.textColor = [0, 0, 0];
                    data.cell.styles.fontStyle = 'bold';
                }
            }
        }
    });

    let finalY = doc.lastAutoTable.finalY + 10;
    const stats = {};
    rows.each(function() { const st = $(this).find('td:eq(4)').text().trim(); if(st) stats[st] = (stats[st] || 0) + 1; });
    doc.setTextColor(0,0,0); doc.setFontSize(10); doc.text("RESUMO POR STATUS:", 15, finalY);
    doc.autoTable({
        startY: finalY + 2,
        head: [["STATUS", "TOTAL"]],
        body: Object.keys(stats).map(k => [k, stats[k]]),
        tableWidth: 60,
        styles: { fontSize: 8, halign: 'center', textColor: [0,0,0], lineColor: [0,0,0], lineWidth: 0.1 },
        headStyles: { fillColor: [200, 200, 200], textColor: [0,0,0] }
    });

    doc.save("Recebimento_MS.pdf");
}

function exportarExcel() {
    table.order([0, 'asc']).draw();
    const rows = table.rows({ search: 'applied' }).data().toArray();
    const cleanData = [colunas];
    rows.forEach(row => cleanData.push(row.map(c => c.replace(/<[^>]*>/g, "").trim())));
    const ws = XLSX.utils.aoa_to_sheet(cleanData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Recebimento");
    XLSX.writeFile(wb, "Recebimento_MS.xlsx");
}
</script>
</body>
</html>
