<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>RECEBIMENTO - M√ìVEIS SIMONETTI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#CC0000">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Recebimento Simonetti">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

  <style>
    body { background-color: #FFFFFF; font-family: Arial, sans-serif; color: #000; padding: 10px; margin: 0; box-sizing: border-box; }
    h1 { 
      margin-bottom: 16px; 
      background-color: #808080; 
      padding: 10px; 
      border-radius: 4px; 
      font-size: 6vw; 
      text-align: center; 
      color: #fff; 
    }
    @media (min-width: 768px) { 
      h1 { font-size: 28px; } 
    }
    table { width: 100%; font-size: 13px; border-collapse: collapse; }
    thead tr th { 
      background: #808080; 
      color: #fff; 
      padding: 8px; 
      text-align: center; 
      font-weight: bold; 
      border: 1px solid #CCC; 
    }
    tbody tr:nth-child(even) { background-color: #F2F2F2; }
    tbody tr:nth-child(odd) { background-color: #FFF; }
    td { padding: 8px 12px; border: 1px solid #CCC; white-space: nowrap; text-align: center; max-width: 150px; overflow: hidden; text-overflow: ellipsis; color: #000; }
    
    .filter-select { width: 100%; padding: 6px; font-size: 13px; background: #E0F4FF; border: 1px solid #CCC; border-radius: 4px; color: #000; text-align: center; appearance: auto; cursor: pointer;}
    .filter-select.applied {
        background-color: #FFD700;
        font-weight: bold;
    }
    
    input.dataTables_filter input { color: #000 !important; background: #E0F4FF !important; border-radius: 4px; border: 1px solid #CCC; padding: 4px 8px; font-size: 14px; box-sizing: border-box; }
    table.dataTable th, table.dataTable td { min-width: 120px; text-align: center; }
    div.dataTables_wrapper { overflow-x: auto; position: relative; }
    
    @media (max-width: 768px) { table.dataTable { display: block; width: max-content; } .filter-select { font-size: 14px; } td, th { font-size: 12px; } }
    
    .dataTables_wrapper .dataTables_paginate .paginate_button { color: #CC0000 !important; background-color: #fff !important; border: 1px solid #CCC !important; border-radius: 4px; padding: 4px 8px; margin: 2px; font-weight: bold; }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover { background-color: #f1f1f1 !important; color: #000 !important; }
    
    /* Melhoria no Posicionamento do Compartilhar */
    .share-container { position: relative; display: inline-block; }
    #btnShare { background:#CC0000; color:#fff; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-left:10px; }
    #btnShare:hover { background:#A80000; }
    #shareMenu { 
      display:none; 
      position:absolute; 
      right: 0; 
      top: 35px;
      background:#fff; 
      border:1px solid #ccc; 
      border-radius:6px; 
      box-shadow:0 4px 12px rgba(0,0,0,0.2); 
      z-index:3000; 
      min-width: 160px;
    }
    #shareMenu .share-option { 
      padding:12px; 
      cursor:pointer; 
      font-size:14px; 
      color:#333; 
      border-bottom: 1px solid #eee;
      text-align:left;
    }
    #shareMenu .share-option:hover { background: #f8f8f8; color: #CC0000; }
    #shareMenu .share-option:last-child { border-bottom: none; }
    
    /* Modal de Filtro Profissional */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      max-height: 80%;
      overflow-y: auto;
      max-width: 90%;
      min-width: 300px;
      display: flex;
      flex-direction: column;
    }
    .modal-checkbox-list {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      overflow-y: auto;
    }
    .modal-checkbox-list label {
      margin: 2px 0;
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal-checkbox-list label:hover:not(.disabled-option) { background-color: #f0f4f8; }
    .modal-checkbox-list input { margin-right: 10px; transform: scale(1.2); }
    
    .disabled-option { color: #ccc; opacity: 0.6; cursor: not-allowed !important; }
    
    #modalButtons {
      display: flex;
      justify-content: space-between;
      position: sticky;
      top: 0;
      background: white;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
      margin: 0 -20px 15px -20px;
      padding-left: 20px;
      padding-right: 20px;
      z-index: 10;
    }
    #modalButtons button {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      color: #fff;
      flex-grow: 1;
      margin: 0 5px;
    }
    #btnSelectAll { background-color: #007bff; }
    #btnSelectNone { background-color: #dc3545; }
    #btnApplyFilter { background-color: #28a745; }
    #btnCancel { background-color: #6c757d; }

    /* Popups de detalhes */
    #notaOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; }
    #notaPopup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; color: #000; border-radius: 10px; padding: 20px; max-width: 90%; max-height: 70%; overflow-y: auto; z-index: 2100; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    #notaPopup h2 { margin-top: 0; color: #CC0000; }
    #notaPopup button { margin-top: 12px; padding: 6px 14px; border: none; background: #CC0000; color: #fff; border-radius: 6px; cursor: pointer; font-weight: bold; }
  </style>
</head>
<body>

<script>
  if (localStorage.getItem("isLoggedIn") !== "true") { window.location.href = "login.html"; }
</script>

<div id="userBar" style="background:#808080; padding:10px; display:flex; justify-content:space-between; align-items:center; border-radius:6px; margin-bottom:12px;">
  <button onclick="history.back()" style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; margin-right: 10px;">‚Üê</button>
  <span id="welcomeUser" style="font-weight:bold; color:#fff; flex-grow: 1;"></span>
  <button onclick="logout()" style="background:#808080; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; font-weight:bold;">Sair</button>
</div>

<h1>RECEBIMENTO - M√ìVEIS SIMONETTI</h1>

<table id="planilha" class="display nowrap">
  <thead>
    <tr class="headers"></tr>
    <tr class="filters"></tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr><th style="text-align:right; font-weight:bold;" id="totalCargas">Total de Cargas: 0</th></tr>
  </tfoot>
</table>

<div id="filterModalOverlay" class="modal-overlay">
    <div id="filterModalContent" class="modal-content">
        <div id="modalTitle" style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;"></div>
        <div id="modalCheckboxList" class="modal-checkbox-list"></div>
        <div id="modalButtons">
            <button id="btnSelectAll">Marcar Todos</button>
            <button id="btnSelectNone">Desmarcar</button>
            <button id="btnCancel">Cancelar</button> 
            <button id="btnApplyFilter">Aplicar</button>
        </div>
    </div>
</div>

<div id="notaOverlay"></div>
<div id="notaPopup">
  <h2 id="popupTitulo">Detalhes</h2>
  <div id="notaConteudo" style="white-space: pre-wrap;"></div>
  <button id="fecharPopup">Fechar</button>
</div>

<script>
const sheetID = "1LaYf3GKID_HdueUpZax7J_aco2-a1UVFBz1pZ4CkUGk";
const gid = "0";
const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv&gid=${gid}`;
const colunasDesejadas = ["SENHA","DATA","CENTRAL","CARGAS", "PEDIDO", "NOTAS","STATUS DA CARGA","FORNECEDOR","TIPO DE PRODUTO"];
let dataTable;

const coresProduto = {
    'ARMARIO': '#FFFF00', 'ARMARIOS': '#FFFF00', 'MODULOS': '#FFFF00', 'MODULO': '#FFFF00',
    'BER√áO': '#FFFF00', 'COMODA': '#FFFF00', 'COZINHA': '#FFFF00', 'MULTIUSO': '#FFFF00',
    'PAINEL': '#FFFF00', 'ROUPEIRO': '#FFFF00', 'CELULAR': '#00BFFF', 'IMPRESSORA': '#00BFFF', 
    'RELOGIOS': '#00BFFF', 'NOTEBOOK': '#00BFFF', 'TABLET': '#00BFFF', 'MESA PLASTICA': '#4CAF50', 'MESA': '#4CAF50'
};

const coresStatus = {
    'OK NO AJUSTE': '#4CAF50', 'SOBRE AJUSTE': '#FFC107', 'SEM NOTA': '#FF0000',
    'REAGENDADA': '#D4A7E8', 'CANCELADA': '#F54927', 'OC PENDENTE': '#7AA7CC',
    'SEM TRIANGULA√á√ÉO': '#FFB6C1', 'VENCIMENTO ERRADO': '#3ACFB9', 'FALTA CTe': '#03A9F4',
    'NOTA ERRADA': '#CCA47A', 'CTe DIVERGENTE': '#9B591B'
};

const username = localStorage.getItem("username") || "Usu√°rio";
document.getElementById("welcomeUser").textContent = "Bem-vindo, " + username;

function logout(){
    localStorage.removeItem("isLoggedIn");
    localStorage.removeItem("username");
    window.location.href = "login.html";
}

Papa.parse(csvUrl, { download: true, header: true, complete: function (results) {
  const data = results.data;
  if(!data.length || Object.keys(data[0]).length===0){ alert("Falha ao carregar dados."); return; }

  results.meta.fields = results.meta.fields.map(f=>f.trim());
  data.forEach(row=>{ 
      Object.keys(row).forEach(k=>{ if(k!==k.trim()){ row[k.trim()]=row[k]; delete row[k]; } });
      colunasDesejadas.forEach(col=>{ if(row[col]) row[col]=row[col].trim(); });
  });

  const headerRow = document.querySelector("#planilha thead tr.headers");
  const filterRow = document.querySelector("#planilha thead tr.filters");
  const tableBody = document.querySelector("#planilha tbody");

  colunasDesejadas.forEach(col => {
    headerRow.innerHTML += `<th>${col}</th>`;
    filterRow.innerHTML += `<th><button class="filter-select" data-column-name="${col}">Filtrar / Limpar</button></th>`;
  });
  
  document.querySelector("#planilha tfoot th").setAttribute("colspan", colunasDesejadas.length);

  data.forEach(row => {
    let rowHtml = "<tr>";
    colunasDesejadas.forEach(col => {
      let valor = row[col] || "";
      if(col==="NOTAS" && valor==="") valor="Sem nota";
      
      if(col === "TIPO DE PRODUTO" && coresProduto[valor.toUpperCase()]) { 
          rowHtml += `<td style="background-color: ${coresProduto[valor.toUpperCase()]};">${valor}</td>`;
      } else if (col === "STATUS DA CARGA" && coresStatus[valor]) {
          rowHtml += `<td style="background-color: ${coresStatus[valor]}; color: white; font-weight: bold;">${valor}</td>`;
      } else if(["NOTAS", "CARGAS", "PEDIDO"].includes(col)) { 
          rowHtml += `<td class="popup-cell" data-col="${col}" data-text="${valor}">${valor}</td>`;
      } else {
          rowHtml += `<td>${valor}</td>`;
      }
    });
    rowHtml += "</tr>";
    tableBody.innerHTML += rowHtml;
  });

  dataTable = $("#planilha").DataTable({
    paging:false, searching:true, info:false, scrollX:true, autoWidth:false,
    fixedHeader:{header:true, headerOffset:0},
    stateSave:true,
    language:{search:"Buscar:", zeroRecords:"Nenhum registro encontrado"}
  });

  // L√≥gica do Filtro Inteligente (MELHORADO COM ORDENA√á√ÉO DE DATA)
  $(document).on('click', '.filter-select', function() {
      const columnIndex = $(this).closest('th').index();
      const columnName = colunasDesejadas[columnIndex];
      
      // Pega todos os valores √∫nicos sem filtros
      let allUniqueValues = dataTable.column(columnIndex, {filter: 'none'}).data().unique().toArray();
      
      // ORDENA√á√ÉO SEQUENCIAL PARA DATAS (01/03/2026...)
      if (columnName === "DATA") {
          allUniqueValues.sort((a, b) => {
              const parseDate = (d) => {
                if(!d) return new Date(0);
                const p = d.split('/');
                return new Date(p[2], p[1]-1, p[0]);
              };
              return parseDate(a) - parseDate(b);
          });
      } else {
          allUniqueValues.sort();
      }
      
      // L√≥gica de comunica√ß√£o: v√™ o que est√° vis√≠vel baseado nos filtros das OUTRAS colunas
      const oldSearch = dataTable.column(columnIndex).search();
      dataTable.column(columnIndex).search('').draw();
      const visibleValues = dataTable.column(columnIndex, {filter: 'applied'}).data().unique().toArray();
      dataTable.column(columnIndex).search(oldSearch).draw(); 
      
      const savedFilter = localStorage.getItem(`filtroColuna${columnIndex}`);
      const savedValues = savedFilter ? JSON.parse(savedFilter) : [];
      
      let checkboxesHtml = '';
      allUniqueValues.forEach(value => {
          if (value) {
              const trimmedValue = value.trim(); 
              const isChecked = savedValues.includes(trimmedValue) ? 'checked' : '';
              const isAvailable = visibleValues.includes(value);
              const isDisabled = (!isAvailable && !isChecked) ? 'disabled' : '';
              const optionClass = (!isAvailable && !isChecked) ? 'disabled-option' : '';
              
              checkboxesHtml += `
                  <label class="${optionClass}">
                      <input type="checkbox" value="${trimmedValue}" ${isChecked} ${isDisabled}> ${trimmedValue}
                  </label>
              `;
          }
      });

      $('#modalTitle').text(`Filtrar por ${columnName}`);
      $('#modalCheckboxList').html(checkboxesHtml);
      $('#filterModalOverlay').data('column-index', columnIndex).show();
  });

  // Bot√µes do Modal
  $('#btnSelectAll').on('click', function() { $('#modalCheckboxList input:not(:disabled)').prop('checked', true); });
  $('#btnSelectNone').on('click', function() { $('#modalCheckboxList input').prop('checked', false); });
  $('#btnCancel').on('click', function() { $('#filterModalOverlay').hide(); });
  $('#btnApplyFilter').on('click', function() {
      const columnIndex = $('#filterModalOverlay').data('column-index');
      const selectedValues = $('#modalCheckboxList input:checked').map(function() { return this.value; }).get();
      localStorage.setItem(`filtroColuna${columnIndex}`, JSON.stringify(selectedValues));
      
      const searchString = selectedValues.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|');
      dataTable.column(columnIndex).search(searchString, true, false).draw();
      atualizarBotaoFiltro();
      $('#filterModalOverlay').hide();
  });

  function atualizarBotaoFiltro() {
    colunasDesejadas.forEach((col, index) => {
      const savedFilter = localStorage.getItem(`filtroColuna${index}`);
      const selectedValues = savedFilter ? JSON.parse(savedFilter) : [];
      const button = $(`.filter-select[data-column-name="${col}"]`);
      if (selectedValues.length > 0) button.text("APLICADO").addClass("applied");
      else button.text("Filtrar / Limpar").removeClass("applied");
    });
  }

  function atualizarTotal(){
    const total = dataTable.rows({search:'applied'}).data().length;
    document.getElementById("totalCargas").textContent = "Total de Cargas: " + total;
  }
  
  dataTable.on('draw', atualizarTotal);
  
  // Inicializa√ß√£o de filtros salvos
  colunasDesejadas.forEach((_, i) => {
      const saved = localStorage.getItem(`filtroColuna${i}`);
      if(saved && JSON.parse(saved).length > 0){
          const vals = JSON.parse(saved);
          const search = vals.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|');
          dataTable.column(i).search(search, true, false);
      }
  });
  dataTable.draw();
  atualizarBotaoFiltro();

  // Menu de Compartilhamento com Melhor Posicionamento
  $("#planilha_filter").append(`
    <div class="share-container">
        <button id="btnShare">üì§ Compartilhar</button>
        <div id="shareMenu">
          <div class="share-option" onclick="exportPDF(dataTable)">üìÑ Exportar PDF</div>
          <div class="share-option" onclick="exportExcel(dataTable)">üìä Exportar Excel</div>
        </div>
    </div>
  `);

  $("#btnShare").on("click", function(e){ 
      e.stopPropagation();
      $("#shareMenu").toggle(); 
  });
  $(document).on("click", function() { $("#shareMenu").hide(); });
}});

// Popups
$(document).on("click",".popup-cell",function(){
  $("#popupTitulo").text($(this).data("col"));
  $("#notaConteudo").text($(this).data("text"));
  $("#notaOverlay, #notaPopup").fadeIn(200);
});
$("#fecharPopup, #notaOverlay").on("click",function(){ $("#notaOverlay, #notaPopup").fadeOut(200); });

// Fun√ß√µes de Exporta√ß√£o (VERS√ÉO PROFISSIONAL COM CABE√áALHO E CONTADOR)
function hexToRgb(hex) {
    let r=0, g=0, b=0;
    if(hex.length===4){ r=parseInt(hex[1]+hex[1],16); g=parseInt(hex[2]+hex[2],16); b=parseInt(hex[3]+hex[3],16); }
    else{ r=parseInt(hex.substring(1,3),16); g=parseInt(hex.substring(3,5),16); b=parseInt(hex.substring(5,7),16); }
    return [r,g,b];
}

async function exportPDF(table){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"landscape"});
  const data = table.rows({search:"applied"}).data().toArray();
  const totalCargas = data.length;
  const dataHora = new Date().toLocaleString('pt-BR');
  
  const statusIdx = colunasDesejadas.indexOf("STATUS DA CARGA");
  const prodIdx = colunasDesejadas.indexOf("TIPO DE PRODUTO");

  // Estiliza√ß√£o do Topo do PDF
  doc.setFillColor(60, 60, 60); // Cinza Escuro
  doc.rect(0, 0, doc.internal.pageSize.getWidth(), 35, 'F');
  
  doc.setTextColor(255, 255, 255);
  doc.setFontSize(18);
  doc.text("M√ìVEIS SIMONETTI - RELAT√ìRIO DE RECEBIMENTO", 15, 15);
  
  // Caixa de Destaque para o Total
  doc.setFillColor(204, 0, 0); // Vermelho Simonetti
  doc.roundedRect(15, 22, 60, 10, 2, 2, 'F');
  doc.setFontSize(10);
  doc.text(`TOTAL DE CARGAS: ${totalCargas}`, 20, 28.5);
  
  doc.setFontSize(9);
  doc.text(`Gerado em: ${dataHora}`, doc.internal.pageSize.getWidth() - 15, 28.5, {align: 'right'});

  doc.autoTable({
    startY: 40, 
    head:[colunasDesejadas], 
    body:data,
    theme: 'grid',
    styles: { fontSize: 7, halign: 'center', overflow: 'linebreak' },
    headStyles: { fillColor: [100, 100, 100], textColor: [255, 255, 255], fontStyle: 'bold' },
    didParseCell: function(cellData) {
        if(cellData.section === 'body'){
            if(cellData.column.index === statusIdx){
                const val = cellData.cell.text[0];
                const color = coresStatus[val];
                if(color){ 
                  cellData.cell.styles.fillColor = hexToRgb(color); 
                  cellData.cell.styles.textColor = [255,255,255]; 
                  cellData.cell.styles.fontStyle = 'bold';
                }
            }
            if(cellData.column.index === prodIdx){
                const val = cellData.cell.text[0].toUpperCase();
                const color = coresProduto[val];
                if(color) cellData.cell.styles.fillColor = hexToRgb(color);
            }
        }
    }
  });
  doc.save(`recebimento_simonetti_${totalCargas}_cargas.pdf`);
}

function exportExcel(table){
  const data = table.rows({search:"applied"}).data().toArray();
  const ws = XLSX.utils.aoa_to_sheet([colunasDesejadas, ...data]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Recebimento");
  XLSX.writeFile(wb, "recebimento_simonetti.xlsx");
}
</script>
</body>
</html>
